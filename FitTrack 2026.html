<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitTrack 2026 - 減脂戰鬥紀錄</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 1. React Core -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 2. Dependencies for Recharts -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/react-is@18.2.0/umd/react-is.production.min.js"></script>

    <!-- 3. Recharts (Stable UMD Version) -->
    <script src="https://unpkg.com/recharts@2.12.3/umd/Recharts.js"></script>
    
    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const Recharts = window.Recharts || {};
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Line, ComposedChart, Bar } = Recharts;

        // --- 內建 SVG 圖標元件 (解決 Lucide UMD 錯誤) ---
        const IconBase = ({ children, color = "currentColor", size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                {children}
            </svg>
        );

        const Dumbbell = (props) => <IconBase {...props}><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></IconBase>;
        const Scale = (props) => <IconBase {...props}><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></IconBase>;
        const TrendingDown = (props) => <IconBase {...props}><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></IconBase>;
        const Calendar = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const CheckCircle2 = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const Circle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const LayoutDashboard = (props) => <IconBase {...props}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconBase>;
        const History = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Trophy = (props) => <IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const Utensils = (props) => <IconBase {...props}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></IconBase>;
        const Flame = (props) => <IconBase {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3Z"/></IconBase>;
        const Activity = (props) => <IconBase {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></IconBase>;
        const Timer = (props) => <IconBase {...props}><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></IconBase>;
        const Footprints = (props) => <IconBase {...props}><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 1.25-1 2-1 2.5 0 .83.67 1.5 1.5 1.5H12c.55 0 1 .45 1 1v2.38c0 2.12 1.03 3.12 1 5.62-.03 2.72-1.49 6-4.5 6C7.63 22 6 20.2 6 16c0-1.25 1-2 1-2.5 0-.83-.67-1.5-1.5-1.5H5c-.55 0-1-.45-1-1Z"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;

        // --- App 主程式 ---
        const DEFAULT_WORKOUTS = [
            {
                id: 'push',
                type: 'strength',
                name: '推 (胸/肩/三頭)',
                exercises: [
                    { name: '槓鈴臥推', defaultSets: 4, defaultReps: '8-12' },
                    { name: '上斜啞鈴臥推', defaultSets: 3, defaultReps: '10-12' },
                    { name: '啞鈴肩推', defaultSets: 4, defaultReps: '10-12' },
                    { name: '三頭肌滑輪下壓', defaultSets: 3, defaultReps: '12-15' },
                    { name: '啞鈴側平舉', defaultSets: 4, defaultReps: '15-20' },
                ]
            },
            {
                id: 'pull',
                type: 'strength',
                name: '拉 (背/二頭/後肩)',
                exercises: [
                    { name: '引體向上/滑輪下拉', defaultSets: 4, defaultReps: '8-12' },
                    { name: '槓鈴划船', defaultSets: 4, defaultReps: '8-12' },
                    { name: '臉拉 (Face Pull)', defaultSets: 3, defaultReps: '15-20' },
                    { name: '槓鈴二頭彎舉', defaultSets: 3, defaultReps: '10-12' },
                    { name: '單臂啞鈴划船', defaultSets: 3, defaultReps: '10-12' },
                ]
            },
            {
                id: 'legs',
                type: 'strength',
                name: '腿 (股四頭/腿後)',
                exercises: [
                    { name: '槓鈴深蹲', defaultSets: 4, defaultReps: '6-10' },
                    { name: '羅馬尼亞硬舉', defaultSets: 4, defaultReps: '8-12' },
                    { name: '腿推機', defaultSets: 3, defaultReps: '10-15' },
                    { name: '分腿蹲', defaultSets: 3, defaultReps: '10-12' },
                    { name: '棒式 (Plank)', defaultSets: 3, defaultReps: '60s' },
                ]
            },
            {
                id: 'cardio',
                type: 'cardio',
                name: '有氧 (燃脂/心肺)',
                exercises: [
                    { name: '跑步機 (Treadmill)', defaultSets: '30', defaultReps: 'mins' },
                    { name: '戶外跑步 (Running)', defaultSets: '5', defaultReps: 'km' },
                    { name: '飛輪/單車 (Cycling)', defaultSets: '45', defaultReps: 'mins' },
                    { name: '滑步機 (Elliptical)', defaultSets: '30', defaultReps: 'mins' },
                    { name: '跳繩 (Jump Rope)', defaultSets: '15', defaultReps: 'mins' },
                    { name: 'HIIT 間歇運動', defaultSets: '20', defaultReps: 'mins' },
                ]
            }
        ];

        function FitTrackApp() {
            // --- State Management ---
            const [activeTab, setActiveTab] = useState('dashboard');
            
            // 安全的 localStorage 讀取
            const getStoredItem = (key, defaultValue) => {
                try {
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : defaultValue;
                } catch (e) {
                    console.warn('LocalStorage access failed:', e);
                    return defaultValue;
                }
            };

            const setStoredItem = (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.warn('LocalStorage write failed:', e);
                }
            };

            // User Data & Settings
            const [userProfile, setUserProfile] = useState(() => getStoredItem('fitTrack_profile', {
                startWeight: 80,
                targetWeight: 70,
                targetDate: '2026-12-31',
                height: 175,
                age: 30,
                gender: 'male',
                activityLevel: 1.375,
            }));

            // Logs
            const [logs, setLogs] = useState(() => getStoredItem('fitTrack_logs', [
                { date: '2026-01-01', weight: 80, bodyFat: 25, calories: 2500, protein: 120, notes: '新年新希望，開始減脂！' },
            ]));

            // Workout Logs
            const [workoutLogs, setWorkoutLogs] = useState(() => getStoredItem('fitTrack_workouts_v2', {}));

            // Today's Input State
            const todayStr = new Date().toISOString().split('T')[0];
            
            const [todayInput, setTodayInput] = useState({
                weight: '',
                bodyFat: '',
                calories: '',
                protein: '',
                notes: ''
            });

            // Auto-load today's data if exists
            useEffect(() => {
                const existingLog = logs.find(l => l.date === todayStr);
                if (existingLog) {
                    setTodayInput({
                        weight: existingLog.weight || '',
                        bodyFat: existingLog.bodyFat || '',
                        calories: existingLog.calories || '',
                        protein: existingLog.protein || '',
                        notes: existingLog.notes || ''
                    });
                }
            }, [logs, todayStr]);

            // Selected workout plan for today
            const [selectedPlanId, setSelectedPlanId] = useState('push');
            const [saveMessage, setSaveMessage] = useState('');

            // --- Effects ---
            useEffect(() => {
                setStoredItem('fitTrack_profile', userProfile);
            }, [userProfile]);

            useEffect(() => {
                setStoredItem('fitTrack_logs', logs);
            }, [logs]);

            useEffect(() => {
                setStoredItem('fitTrack_workouts_v2', workoutLogs);
            }, [workoutLogs]);

            // --- Helpers ---
            const currentWeight = logs.length > 0 ? logs[logs.length - 1].weight : userProfile.startWeight;
            const currentBodyFat = logs.length > 0 ? logs[logs.length - 1].bodyFat : 0;
            
            // Calculations
            const bmi = (currentWeight / Math.pow(userProfile.height / 100, 2)).toFixed(1);
            
            const calculateTDEE = () => {
                let bmr = 10 * currentWeight + 6.25 * userProfile.height - 5 * userProfile.age;
                bmr += userProfile.gender === 'male' ? 5 : -161;
                return Math.round(bmr * userProfile.activityLevel);
            };
            const tdee = calculateTDEE();
            const recommendedCalories = Math.round(tdee * 0.85); // 15% Deficit
            const recommendedProtein = Math.round(currentWeight * 2.0); // High protein for cutting

            const daysLeft = useMemo(() => {
                const target = new Date(userProfile.targetDate);
                const today = new Date();
                const diffTime = target - today;
                if (diffTime < 0) return 0;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            }, [userProfile.targetDate]);

            const progressPercentage = useMemo(() => {
                const totalToLose = userProfile.startWeight - userProfile.targetWeight;
                const currentLost = userProfile.startWeight - currentWeight;
                if (totalToLose === 0) return 0;
                const pct = (currentLost / totalToLose) * 100;
                return Math.min(Math.max(pct, 0), 100).toFixed(1);
            }, [userProfile.startWeight, userProfile.targetWeight, currentWeight]);

            // --- Handlers ---
            const handleLogSubmit = (e) => {
                e.preventDefault();
                if (!todayInput.weight) return;

                const newLog = {
                    date: todayStr,
                    weight: parseFloat(todayInput.weight),
                    bodyFat: todayInput.bodyFat ? parseFloat(todayInput.bodyFat) : null,
                    calories: todayInput.calories ? parseFloat(todayInput.calories) : null,
                    protein: todayInput.protein ? parseFloat(todayInput.protein) : null,
                    notes: todayInput.notes
                };

                const existingIndex = logs.findIndex(l => l.date === todayStr);
                let newLogs;
                if (existingIndex >= 0) {
                    newLogs = [...logs];
                    newLogs[existingIndex] = { ...newLogs[existingIndex], ...newLog };
                } else {
                    newLogs = [...logs, newLog];
                    newLogs.sort((a, b) => new Date(a.date) - new Date(b.date));
                }
                
                setLogs(newLogs);
                setSaveMessage('紀錄已更新！Keep Grinding!');
                setTimeout(() => setSaveMessage(''), 3000);
            };

            const updateExerciseLog = (planId, exerciseIndex, field, value) => {
                const currentDayLogs = workoutLogs[todayStr] || {};
                const currentPlanLogs = currentDayLogs[planId] || {};
                const currentExerciseLog = currentPlanLogs[exerciseIndex] || { completed: false };

                const updatedExerciseLog = { ...currentExerciseLog, [field]: value };
                
                if (value !== '') {
                    updatedExerciseLog.completed = true;
                }

                setWorkoutLogs({
                    ...workoutLogs,
                    [todayStr]: {
                        ...currentDayLogs,
                        [planId]: {
                            ...currentPlanLogs,
                            [exerciseIndex]: updatedExerciseLog
                        }
                    }
                });
            };

            const toggleExerciseCompletion = (planId, exerciseIndex) => {
                const currentStatus = workoutLogs[todayStr]?.[planId]?.[exerciseIndex]?.completed || false;
                updateExerciseLog(planId, exerciseIndex, 'completed', !currentStatus);
            };

            const deleteLog = (date) => {
                if (confirm('確定要刪除這筆紀錄嗎？')) {
                    setLogs(logs.filter(l => l.date !== date));
                }
            };

            // --- Components ---

            const Dashboard = () => {
                const todayCalories = todayInput.calories ? parseFloat(todayInput.calories) : 0;
                const caloriePct = Math.min((todayCalories / recommendedCalories) * 100, 100);
                const calorieColor = todayCalories > recommendedCalories ? 'bg-red-500' : 'bg-orange-500';

                return (
                    <div className="space-y-6 animate-fade-in">
                        {/* Top Stats Cards */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-rose-500 border border-slate-100">
                                <p className="text-xs text-slate-500 mb-1 font-semibold tracking-wide uppercase">目前體重 / BMI</p>
                                <div className="flex items-baseline gap-2">
                                    <p className="text-2xl font-black text-slate-800">{currentWeight}</p>
                                    <span className="text-xs px-1.5 py-0.5 rounded bg-slate-100 text-slate-600 font-bold">BMI {bmi}</span>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-orange-500 border border-slate-100">
                                <p className="text-xs text-slate-500 mb-1 font-semibold tracking-wide uppercase">每日消耗 TDEE</p>
                                <div className="flex items-baseline gap-2">
                                    <p className="text-2xl font-black text-orange-600">{tdee}</p>
                                    <span className="text-xs text-slate-400 font-bold">kcal</span>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-emerald-500 border border-slate-100">
                                <p className="text-xs text-slate-500 mb-1 font-semibold tracking-wide uppercase">減脂目標熱量</p>
                                <div className="flex items-baseline gap-2">
                                    <p className="text-2xl font-black text-emerald-600">{recommendedCalories}</p>
                                    <span className="text-xs text-slate-400 font-bold">kcal</span>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-blue-600 border border-slate-100">
                                <p className="text-xs text-slate-500 mb-1 font-semibold tracking-wide uppercase">剩餘戰鬥天數</p>
                                <p className="text-2xl font-black text-blue-700">{daysLeft} <span className="text-sm font-bold text-slate-400">天</span></p>
                            </div>
                        </div>

                        {/* Nutrition Progress */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <Utensils className="w-5 h-5 text-orange-500" />
                                今日營養儀表板
                            </h3>
                            <div className="space-y-4">
                                <div>
                                    <div className="flex justify-between text-xs font-bold text-slate-600 mb-1">
                                        <span>熱量攝取: {todayCalories} / {recommendedCalories} kcal</span>
                                        <span className={todayCalories > recommendedCalories ? 'text-red-500' : 'text-emerald-500'}>
                                            {todayCalories > recommendedCalories ? '已超標' : '控制中'}
                                        </span>
                                    </div>
                                    <div className="w-full bg-slate-100 rounded-full h-4 overflow-hidden shadow-inner">
                                        <div 
                                            className={`h-4 rounded-full transition-all duration-700 ${calorieColor}`}
                                            style={{ width: `${caloriePct}%` }}
                                        ></div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2 text-xs text-slate-500 bg-slate-50 p-2 rounded">
                                    <AlertCircle className="w-4 h-4 text-blue-500" />
                                    <span>建議蛋白質攝取: <strong>{recommendedProtein}g</strong> (體重 x 2.0g) 以維持肌肉量</span>
                                </div>
                            </div>
                        </div>

                        {/* Charts */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h3 className="font-bold text-slate-700 mb-6 flex items-center gap-2">
                                <TrendingDown className="w-5 h-5 text-rose-600" />
                                戰鬥數據分析
                            </h3>
                            <div className="h-72 w-full">
                                {Recharts && AreaChart ? (
                                    <ResponsiveContainer width="100%" height="100%">
                                        <ComposedChart data={logs}>
                                            <defs>
                                                <linearGradient id="colorWeight" x1="0" y1="0" x2="0" y2="1">
                                                    <stop offset="5%" stopColor="#e11d48" stopOpacity={0.2}/>
                                                    <stop offset="95%" stopColor="#e11d48" stopOpacity={0}/>
                                                </linearGradient>
                                            </defs>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                            <XAxis dataKey="date" tick={{fontSize: 12, fill: '#64748b', fontWeight: 'bold'}} tickMargin={10} />
                                            <YAxis yAxisId="left" domain={['dataMin - 1', 'dataMax + 1']} tick={{fontSize: 12, fill: '#64748b', fontWeight: 'bold'}} />
                                            <YAxis yAxisId="right" orientation="right" domain={[0, 'dataMax + 500']} hide />
                                            <Tooltip 
                                                contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)', backgroundColor: '#1e293b', color: '#fff'}}
                                                itemStyle={{color: '#fff'}}
                                                labelStyle={{color: '#94a3b8', marginBottom: '0.5rem'}}
                                            />
                                            <Area 
                                                yAxisId="left"
                                                type="monotone" 
                                                dataKey="weight" 
                                                stroke="#e11d48" 
                                                strokeWidth={4}
                                                fillOpacity={1} 
                                                fill="url(#colorWeight)" 
                                                name="體重 (kg)"
                                                activeDot={{r: 6, strokeWidth: 0, fill: '#e11d48'}}
                                            />
                                            <Bar 
                                                yAxisId="right"
                                                dataKey="calories" 
                                                barSize={20}
                                                fill="#f59e0b" 
                                                radius={[4, 4, 0, 0]}
                                                name="攝取熱量 (kcal)"
                                                opacity={0.6}
                                            />
                                            <Legend verticalAlign="top" height={36} iconType="circle"/>
                                        </ComposedChart>
                                    </ResponsiveContainer>
                                ) : (
                                    <div className="w-full h-full flex items-center justify-center text-slate-400 bg-slate-50 rounded-lg border border-dashed border-slate-300">
                                        <p>圖表載入中... (若長時間未顯示，請檢查網路連線)</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Quick Log Input */}
                        <div className="bg-gradient-to-br from-slate-900 to-rose-900 p-6 rounded-xl shadow-xl text-white border border-rose-900/50 relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-8 opacity-10 pointer-events-none">
                                <Flame className="w-32 h-32 text-rose-500" />
                            </div>
                            
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 relative z-10">
                                <Plus className="w-5 h-5 text-rose-400" />
                                今日戰績紀錄 ({todayStr})
                            </h3>
                            <form onSubmit={handleLogSubmit} className="grid grid-cols-2 gap-4 relative z-10">
                                <div>
                                    <label className="text-xs text-rose-200/70 block mb-1 flex items-center gap-1 font-bold"><Scale className="w-3 h-3"/> 體重 (kg)</label>
                                    <input 
                                        type="number" step="0.1" 
                                        value={todayInput.weight}
                                        onChange={(e) => setTodayInput({...todayInput, weight: e.target.value})}
                                        className="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-rose-500 focus:bg-black/50 transition-all font-bold placeholder-white/20"
                                        placeholder={currentWeight}
                                    />
                                </div>
                                <div>
                                    <label className="text-xs text-rose-200/70 block mb-1 flex items-center gap-1 font-bold"><Activity className="w-3 h-3"/> 體脂 (%)</label>
                                    <input 
                                        type="number" step="0.1" 
                                        value={todayInput.bodyFat}
                                        onChange={(e) => setTodayInput({...todayInput, bodyFat: e.target.value})}
                                        className="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-rose-500 focus:bg-black/50 transition-all font-bold placeholder-white/20"
                                        placeholder={currentBodyFat || '0'}
                                    />
                                </div>
                                <div>
                                    <label className="text-xs text-rose-200/70 block mb-1 flex items-center gap-1 font-bold"><Flame className="w-3 h-3"/> 熱量 (kcal)</label>
                                    <input 
                                        type="number"
                                        value={todayInput.calories}
                                        onChange={(e) => setTodayInput({...todayInput, calories: e.target.value})}
                                        className="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-rose-500 focus:bg-black/50 transition-all font-bold placeholder-white/20"
                                        placeholder={recommendedCalories}
                                    />
                                </div>
                                <div>
                                    <label className="text-xs text-rose-200/70 block mb-1 flex items-center gap-1 font-bold"><Utensils className="w-3 h-3"/> 蛋白質 (g)</label>
                                    <input 
                                        type="number"
                                        value={todayInput.protein}
                                        onChange={(e) => setTodayInput({...todayInput, protein: e.target.value})}
                                        className="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-rose-500 focus:bg-black/50 transition-all font-bold placeholder-white/20"
                                        placeholder={recommendedProtein}
                                    />
                                </div>
                                <div className="col-span-2">
                                    <label className="text-xs text-rose-200/70 block mb-1 flex items-center gap-1 font-bold"><FileText className="w-3 h-3"/> 戰鬥日記 (心情/飲食備註)</label>
                                    <textarea 
                                        value={todayInput.notes}
                                        onChange={(e) => setTodayInput({...todayInput, notes: e.target.value})}
                                        className="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-rose-500 focus:bg-black/50 transition-all font-bold placeholder-white/20 text-sm h-20 resize-none"
                                        placeholder="今天狀況如何？吃了什麼？寫下來吧！"
                                    />
                                </div>
                                <button type="submit" className="col-span-2 bg-rose-600 hover:bg-rose-500 text-white p-3 rounded-lg transition-colors font-black mt-2 flex justify-center items-center gap-2 shadow-lg shadow-rose-900/50 uppercase tracking-widest text-sm transform active:scale-95 duration-100">
                                    <Save className="w-4 h-4" /> 儲存並繼續戰鬥
                                </button>
                                {saveMessage && (
                                    <div className="col-span-2 text-center text-emerald-400 text-sm font-bold animate-pulse">
                                        {saveMessage}
                                    </div>
                                )}
                            </form>
                        </div>
                    </div>
                );
            };

            const HistorySection = () => (
                <div className="animate-fade-in pb-20">
                    <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <History className="w-6 h-6 text-rose-600" />
                        戰鬥歷程
                    </h2>
                    <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-slate-600 font-bold border-b border-slate-200 uppercase tracking-wider text-xs">
                                    <tr>
                                        <th className="p-4 whitespace-nowrap">日期</th>
                                        <th className="p-4 whitespace-nowrap">體重/體脂</th>
                                        <th className="p-4 whitespace-nowrap">飲食數據</th>
                                        <th className="p-4 text-right">操作</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {[...logs].reverse().map((log, idx) => (
                                        <tr key={idx} className="hover:bg-rose-50/30 transition-colors">
                                            <td className="p-4 font-bold text-slate-700 whitespace-nowrap align-top">
                                                {log.date}
                                                {log.notes && (
                                                    <div className="mt-1 text-xs text-slate-400 font-normal flex gap-1 max-w-[150px] truncate">
                                                        <FileText className="w-3 h-3 min-w-[12px]" />
                                                        {log.notes}
                                                    </div>
                                                )}
                                            </td>
                                            <td className="p-4 align-top">
                                                <div className="font-bold text-slate-800">{log.weight} kg</div>
                                                <div className="text-xs font-medium text-slate-500">{log.bodyFat ? `${log.bodyFat}%` : '-'}</div>
                                            </td>
                                            <td className="p-4 align-top">
                                                <div className="text-orange-600 font-bold">{log.calories ? `${log.calories} kcal` : '-'}</div>
                                                <div className="text-xs font-medium text-slate-500">{log.protein ? `${log.protein}g P` : '-'}</div>
                                            </td>
                                            <td className="p-4 text-right align-top">
                                                <button 
                                                    onClick={() => deleteLog(log.date)}
                                                    className="text-slate-300 hover:text-rose-500 transition-colors p-2"
                                                >
                                                    <Trash2 className="w-4 h-4" />
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                    {logs.length === 0 && (
                                        <tr>
                                            <td colSpan="4" className="p-8 text-center text-slate-400 font-medium">
                                                尚無紀錄，今天就是改變的開始！
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );

            const SettingsSection = () => (
                <div className="animate-fade-in pb-20">
                    <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <Settings className="w-6 h-6 text-rose-600" />
                        個人檔案與目標
                    </h2>
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 space-y-6">
                        {/* Personal Details */}
                        <div className="space-y-4">
                            <h3 className="text-sm font-black text-slate-800 uppercase tracking-wider border-b border-slate-100 pb-2 flex items-center gap-2">
                                <Activity className="w-4 h-4 text-slate-400" />
                                基本資料 (用於計算代謝)
                            </h3>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">身高 (cm)</label>
                                    <input 
                                        type="number" 
                                        value={userProfile.height}
                                        onChange={(e) => setUserProfile({...userProfile, height: parseFloat(e.target.value)})}
                                        className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-rose-500 outline-none font-medium"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">年齡</label>
                                    <input 
                                        type="number" 
                                        value={userProfile.age}
                                        onChange={(e) => setUserProfile({...userProfile, age: parseFloat(e.target.value)})}
                                        className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-rose-500 outline-none font-medium"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">性別</label>
                                    <select 
                                        value={userProfile.gender}
                                        onChange={(e) => setUserProfile({...userProfile, gender: e.target.value})}
                                        className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-rose-500 outline-none bg-white font-medium"
                                    >
                                        <option value="male">男</option>
                                        <option value="female">女</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">日常活動量</label>
                                    <select 
                                        value={userProfile.activityLevel}
                                        onChange={(e) => setUserProfile({...userProfile, activityLevel: parseFloat(e.target.value)})}
                                        className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-rose-500 outline-none bg-white text-sm font-medium"
                                    >
                                        <option value="1.2">久坐 (沒運動)</option>
                                        <option value="1.375">輕度 (每週1-3次)</option>
                                        <option value="1.55">中度 (每週3-5次)</option>
                                        <option value="1.725">高度 (每週6-7次)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        {/* Targets */}
                        <div className="space-y-4 pt-2">
                            <h3 className="text-sm font-black text-slate-800 uppercase tracking-wider border-b border-slate-100 pb-2 flex items-center gap-2">
                                <Trophy className="w-4 h-4 text-slate-400" />
                                減重目標
                            </h3>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">起始體重 (kg)</label>
                                    <input 
                                        type="number" 
                                        value={userProfile.startWeight}
                                        onChange={(e) => setUserProfile({...userProfile, startWeight: parseFloat(e.target.value)})}
                                        className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-rose-500 outline-none font-medium"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">目標體重 (kg)</label>
                                    <input 
                                        type="number" 
                                        value={userProfile.targetWeight}
                                        onChange={(e) => setUserProfile({...userProfile, targetWeight: parseFloat(e.target.value)})}
                                        className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-rose-500 outline-none font-medium"
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">目標達成日期</label>
                                <input 
                                    type="date" 
                                    value={userProfile.targetDate}
                                    onChange={(e) => setUserProfile({...userProfile, targetDate: e.target.value})}
                                    className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-rose-500 outline-none font-medium"
                                />
                            </div>
                        </div>

                        <div className="pt-4 border-t border-slate-100 bg-slate-50 p-4 rounded text-xs text-slate-500 leading-relaxed">
                            * 系統會根據你的身高、體重、年齡與活動量自動計算 TDEE 與建議熱量。
                            <br/>
                            * 資料僅儲存於此裝置瀏覽器中 (LocalStorage)。
                        </div>
                    </div>
                </div>
            );

            // --- Main Render ---
            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-900 pb-24 md:pb-0">
                    
                    {/* Header */}
                    <header className="bg-gradient-to-r from-rose-700 to-orange-600 shadow-lg sticky top-0 z-30">
                        <div className="max-w-3xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                                    <Scale className="w-5 h-5 text-white" />
                                </div>
                                <div>
                                    <h1 className="text-xl font-black text-white leading-tight italic tracking-wide">
                                    FitTrack 2026
                                    </h1>
                                    <p className="text-[10px] text-rose-100 font-bold tracking-widest opacity-80">BE STRONGER</p>
                                </div>
                            </div>
                            <div className="text-right text-white">
                                <div className="text-xs font-bold opacity-90">
                                    {new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' })}
                                </div>
                                <div className="text-[10px] opacity-70">
                                    {new Date().toLocaleDateString('zh-TW', { weekday: 'long' })}
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content Area */}
                    <main className="max-w-3xl mx-auto px-4 py-6">
                        {activeTab === 'dashboard' && <Dashboard />}
                        {activeTab === 'workout' && <WorkoutSection />}
                        {activeTab === 'history' && <HistorySection />}
                        {activeTab === 'settings' && <SettingsSection />}
                    </main>

                    {/* Mobile Navigation Bar (Fixed Bottom) */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 safe-area-pb z-20 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                        <div className="flex justify-around items-center h-16">
                            <button 
                                onClick={() => setActiveTab('dashboard')}
                                className={`flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors ${activeTab === 'dashboard' ? 'text-rose-600' : 'text-slate-400 hover:text-slate-600'}`}
                            >
                                <LayoutDashboard className="w-5 h-5" />
                                <span className="text-[10px] font-bold">總覽</span>
                            </button>
                            <button 
                                onClick={() => setActiveTab('workout')}
                                className={`flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors ${activeTab === 'workout' ? 'text-rose-600' : 'text-slate-400 hover:text-slate-600'}`}
                            >
                                <Dumbbell className="w-5 h-5" />
                                <span className="text-[10px] font-bold">運動</span>
                            </button>
                            <button 
                                onClick={() => setActiveTab('history')}
                                className={`flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors ${activeTab === 'history' ? 'text-rose-600' : 'text-slate-400 hover:text-slate-600'}`}
                            >
                                <History className="w-5 h-5" />
                                <span className="text-[10px] font-bold">紀錄</span>
                            </button>
                            <button 
                                onClick={() => setActiveTab('settings')}
                                className={`flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors ${activeTab === 'settings' ? 'text-rose-600' : 'text-slate-400 hover:text-slate-600'}`}
                            >
                                <Settings className="w-5 h-5" />
                                <span className="text-[10px] font-bold">設定</span>
                            </button>
                        </div>
                    </nav>
                    
                    {/* Desktop Helper */}
                    <div className="hidden md:block fixed right-8 bottom-8">
                        <div className="bg-slate-900 p-4 rounded-lg shadow-xl border border-slate-800 max-w-xs text-white">
                            <p className="text-sm font-bold text-rose-400 mb-1">💡 NO PAIN, NO GAIN</p>
                            <p className="text-xs text-slate-300">昨天的你已經過去，今天的你正在變強。堅持下去！</p>
                        </div>
                    </div>
                </div>
            );
        }

        // Render the App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FitTrackApp />);
    </script>
</body>
</html>