const [workoutLogs, setWorkoutLogs] = useState(() => getStoredItem('fitTrack_workouts_v2', {}));

            const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
            
            const [todayInput, setTodayInput] = useState({
                weight: '',
                bodyFat: '',
                muscleMass: '',
                visceralFat: '',
                calories: '',
                protein: '',
                notes: ''
            });

            useEffect(() => {
                const existingLog = logs.find(l => l.date === currentDate);
                if (existingLog) {
                    setTodayInput({
                        weight: existingLog.weight || '',
                        bodyFat: existingLog.bodyFat || '',
                        muscleMass: existingLog.muscleMass || '',
                        visceralFat: existingLog.visceralFat || '',
                        calories: existingLog.calories || '',
                        protein: existingLog.protein || '',
                        notes: existingLog.notes || ''
                    });
                } else {
                    // Reset inputs if no data for selected date
                    setTodayInput({
                        weight: '',
                        bodyFat: '',
                        muscleMass: '',
                        visceralFat: '',
                        calories: '',
                        protein: '',
                        notes: ''
                    });
                }
            }, [logs, currentDate]);

            const [selectedPlanId, setSelectedPlanId] = useState('push');
            const [saveMessage, setSaveMessage] = useState('');

            useEffect(() => {
                setStoredItem('fitTrack_profile', userProfile);
            }, [userProfile]);

            useEffect(() => {
                setStoredItem('fitTrack_logs', logs);
            }, [logs]);

            useEffect(() => {
                setStoredItem('fitTrack_workouts_v2', workoutLogs);
            }, [workoutLogs]);

            // --- 核心邏輯更新：根據選擇的日期計算當下應顯示的數據 ---
            const getEffectiveStat = (field, fallback = 0) => {
                // 1. 如果使用者正在輸入，優先顯示輸入中的數值 (Live Preview)
                if (todayInput[field] && todayInput[field] !== '') {
                    const val = parseFloat(todayInput[field]);
                    if (!isNaN(val)) return val;
                }
                
                // 2. 否則，找出「小於等於目前選擇日期」的最新一筆紀錄
                // logs 已經是依照日期排序的 (舊 -> 新)
                const validLogs = logs.filter(l => l.date <= currentDate && l[field] !== undefined && l[field] !== null && l[field] !== '');
                
                if (validLogs.length > 0) {
                    return validLogs[validLogs.length - 1][field];
                }

                // 3. 都沒有則回傳預設值
                return fallback;
            };

            const currentWeight = useMemo(() => getEffectiveStat('weight', userProfile.startWeight), [todayInput.weight, logs, currentDate, userProfile.startWeight]);
            const currentBodyFat = useMemo(() => getEffectiveStat('bodyFat', 0), [todayInput.bodyFat, logs, currentDate]);
            const currentMuscleMass = useMemo(() => getEffectiveStat('muscleMass', 0), [todayInput.muscleMass, logs, currentDate]);
            const currentVisceralFat = useMemo(() => getEffectiveStat('visceralFat', 0), [todayInput.visceralFat, logs, currentDate]);
            
            const bmi = (currentWeight / Math.pow(userProfile.height / 100, 2)).toFixed(1);
            
            const calculateTDEE = () => {
                let bmr = 10 * currentWeight + 6.25 * userProfile.height - 5 * userProfile.age;
                bmr += userProfile.gender === 'male' ? 5 : -161;
                return Math.round(bmr * userProfile.activityLevel);
            };
            const tdee = calculateTDEE();
            const recommendedCalories = Math.round(tdee * 0.85); // 15% Deficit
            const recommendedProtein = Math.round(currentWeight * 2.0); // High protein for cutting

            const daysLeft = useMemo(() => {
                const target = new Date(userProfile.targetDate);
                const today = new Date();
                const diffTime = target - today;
                if (diffTime < 0) return 0;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            }, [userProfile.targetDate]);
